<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PeriPage Print (iPad / Web)</title>

<!-- ✅ Safari 완전 호환 html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    background: #fff;
    color: #000;
  }
  #controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 10px 0;
    position: sticky;
    top: 0;
    background: #fff;
    border-bottom: 1px solid #ccc;
    z-index: 100;
  }
  button {
    padding: 8px 14px;
    font-size: 14px;
    border: 1px solid #000;
    background: #fff;
    cursor: pointer;
  }
  #status {
    font-size: 12px;
    text-align: center;
    color: #444;
    margin: 6px 0;
  }
  #paper {
    margin: 0 auto;
    background: #fff;
    box-sizing: content-box;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    font-size: 13px;
  }
  td, th {
    border: 1px solid #000;
    padding: 4px;
    text-align: center;
    word-break: break-word;
  }
  thead th {
    background: #e0e0e0;
  }
  .b { font-weight: bold; }
  .em {
    background: #e0e0e0;
    padding: 6px;
    text-align: center;
    font-weight: bold;
    margin: 8px 0;
  }
</style>
</head>
<body>

<!-- ✅ 상단 고정 버튼 -->
<div id="controls">
  <button id="shareBtn">📤 PeriPage 공유</button>
  <button id="saveBtn">💾 PNG 저장</button>
  <button id="printBtn">🖨️ 인쇄</button>
</div>
<div id="status">준비 중...</div>

<!-- ✅ 출력 내용 -->
<div id="paper">
  <div style="font-size:20px; font-weight:bold; margin-bottom:6px;">이 름: <span data-k="name">이름</span></div>
  <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">연락처: <span data-k="phone">연락처</span></div>
  <hr style="border:none; height:1px; background:#ccc;">
  <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">검사일: <span data-k="date">검사일</span></div>
  <hr style="border:none; height:1px; background:#ccc;">

  <table style="margin-bottom:12px;">
    <colgroup>
      <col style="width:12.5%"><col style="width:12.5%"><col style="width:12.5%"><col style="width:12.5%">
      <col style="width:12.5%"><col style="width:12.5%"><col style="width:12.5%"><col style="width:12.5%">
    </colgroup>
    <thead>
      <tr>
        <th>구분</th><th>SPH</th><th>CYL</th><th>AXIS</th><th>ADD</th><th>단안PD</th><th>PRISM △</th><th>BASE</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="b">OD</td>
        <td><span data-k="od_sph"></span></td>
        <td><span data-k="od_cyl"></span></td>
        <td><span data-k="od_axis"></span></td>
        <td><span data-k="od_add"></span></td>
        <td><span data-k="od_pd"></span></td>
        <td><span data-k="od_prism"></span></td>
        <td><span data-k="od_base"></span></td>
      </tr>
      <tr>
        <td class="b">OS</td>
        <td><span data-k="os_sph"></span></td>
        <td><span data-k="os_cyl"></span></td>
        <td><span data-k="os_axis"></span></td>
        <td><span data-k="os_add"></span></td>
        <td><span data-k="os_pd"></span></td>
        <td><span data-k="os_prism"></span></td>
        <td><span data-k="os_base"></span></td>
      </tr>
    </tbody>
  </table>

  <div class="em">양안 PD: <span data-k="pd"></span></div>

  <div style="font-size:14px; font-weight:bold; margin-bottom:8px;">비고: <span data-k="remark"></span></div>

  <table style="margin-bottom:12px;">
    <thead><tr><th>항목</th><th>제품</th><th>가격</th></tr></thead>
    <tbody>
      <tr><td>테</td><td><span data-k="frame_brand"></span></td><td><span data-k="frame_price"></span> 원</td></tr>
      <tr><td>렌즈</td><td><span data-k="lens_product"></span></td><td><span data-k="lens_price"></span> 원</td></tr>
    </tbody>
  </table>

  <table>
    <thead><tr><th>총액</th><th>선금</th><th>잔금</th></tr></thead>
    <tbody>
      <tr><td><span data-k="sum"></span> 원</td><td><span data-k="deposit"></span> 원</td><td><span data-k="balance"></span> 원</td></tr>
    </tbody>
  </table>
</div>

<script>
/* === 파라미터 === */
const sp = new URL(location.href).searchParams;
const get = (k,d="") => sp.get(k) ? decodeURIComponent(sp.get(k)) : d;

/* === 용지 mm → px === */
const mmToPx = mm => Math.round((mm/25.4)*300);
const W = mmToPx(parseFloat(get('mmw','105')));
const H = mmToPx(parseFloat(get('mmh','150')));
const padX = mmToPx(parseFloat(get('mmlr','6')));
const padY = mmToPx(parseFloat(get('mmtb','15')));
const paper = document.getElementById('paper');
paper.style.width=W+'px';
paper.style.height=H+'px';
paper.style.padding=`${padY}px ${padX}px`;

/* === 데이터 치환 === */
document.querySelectorAll('[data-k]').forEach(el=>{
  const key=el.getAttribute('data-k');
  const val=get(key,null);
  if(val!==null && val!=="") el.textContent=val;
});

function setStatus(t){document.getElementById('status').textContent=t;}

/* === html2canvas 방식 캡처 (Safari 완전 대응) === */
async function renderCanvas(){
  const canvas = await html2canvas(document.getElementById('paper'), {
    scale: 2,
    useCORS: true,
    backgroundColor: "#ffffff"
  });
  return canvas;
}

/* === PeriPage 공유 === */
async function sharePng(){
  try{
    const canvas=await renderCanvas();
    const blob=await new Promise(r=>canvas.toBlob(r,'image/png'));
    const file=new File([blob],'print.png',{type:'image/png'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file],title:'PeriPage Print'});
      setStatus('✅ PeriPage 공유 완료');
    }else{
      alert('⚠️ Safari 주소창의 [aA] → “모바일 웹사이트 요청”을 켜주세요.');
    }
  }catch(e){
    alert('공유 실패: '+e.message);
  }
}

/* === PNG 저장 === */
async function savePng(){
  const canvas=await renderCanvas();
  canvas.toBlob(blob=>{
    const url=URL.createObjectURL(blob);
    window.open(url,'_blank');
    setStatus('💾 PNG 새 탭 열림');
  },'image/png');
}

/* === 인쇄 === */
function browserPrint(){window.print();}

/* === 이벤트 === */
document.getElementById('shareBtn').onclick=sharePng;
document.getElementById('saveBtn').onclick=savePng;
document.getElementById('printBtn').onclick=browserPrint;
setStatus('✅ 준비 완료');
</script>
</body>
</html>
